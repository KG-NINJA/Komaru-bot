name: ğŸ¤– Komaru AutoApp Generator

on:
  schedule:
    - cron: "0 * * * *"     # æ¯æ™‚å®Ÿè¡Œï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
  workflow_dispatch:         # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write            # ã‚³ãƒŸãƒƒãƒˆæ¨©é™ã‚’ä»˜ä¸

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python (for feed parser, optional)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install feed dependencies
        run: pip install feedparser pandas

      - name: Run Komaru Feed Collector
        run: python scripts/komaru_feed.py

      # --- Codex å®Ÿè¡Œå‰ã®æº–å‚™ ---
      - name: Prepare Codex home
        run: |
          mkdir -p /home/runner/work/_temp/codex_home
          chmod -R 777 /home/runner/work/_temp/codex_home

      - name: Prepare output folder
        run: |
          mkdir -p apps/latest_app
          touch apps/latest_app/README.md

      # --- Codex Cloud è‡ªå‹•å‘¼ã³å‡ºã— ---
      - name: Generate AutoApp via Codex Cloud
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}   # Codex Web ã® Responses API Key
          codex-home: /home/runner/work/_temp/codex_home
          safety-strategy: unsafe                         # Codex ã‚’ä¿¡é ¼å®Ÿè¡Œï¼ˆãƒªãƒã‚¸ãƒˆãƒªæ“ä½œå¯ï¼‰
          sandbox: workspace-write
          model: gpt-4o-mini                              # æ˜ç¤ºæŒ‡å®šå¯èƒ½ï¼ˆä»»æ„ï¼‰
          prompt: |
            Read the file specs/komaru_feed.txt.
            Identify the most recent â€œå›°ã‚Šã”ã¨â€.
            Generate a minimal standalone HTML/JS app that solves it.
            Save outputs into:
              - apps/latest_app/index.html
              - apps/latest_app/README.md
            The app should have:
              - blue-toned design
              - standalone client-side logic
              - readable Japanese text
              - signature "#KGNINJA AutoApp" at the bottom.

          output-file: apps/latest_app/README.md

      # --- Codex ã®å‡ºåŠ›ã‚’ç¢ºèª ---
      - name: Show generated README preview
        if: always()
        run: |
          echo "===== Codex Output Preview ====="
          head -n 30 apps/latest_app/README.md || echo "(no README.md found)"
          echo "================================"

      # --- è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆãƒ»Push ---
      - name: Commit & Push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/latest_app/*
          git diff --staged --quiet || git commit -m "ğŸ¤– Auto-generated Komaru App [#KGNINJA]"
          git push

      # --- GitHub Pages ç”¨ã« artifacts æº–å‚™ï¼ˆä»»æ„ï¼‰ ---
      - name: Upload generated app as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: latest_autoapp
          path: apps/latest_app/
