name: ğŸ§  Komaru Auto App Generator

on:
  schedule:
    - cron: "0 * * * *"   # æ¯æ™‚å®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect_and_generate:
    runs-on: ubuntu-latest

    steps:
      # --- ãƒªãƒã‚¸ãƒˆãƒªå–å¾— ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ ---
      - name: Install dependencies
        run: pip install feedparser pandas

      # --- å›°ã‚Šã”ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆ ---
      - name: Run Komaru Feed Generator
        run: python scripts/komaru_feed.py

      # --- æ›´æ–°ã‚³ãƒŸãƒƒãƒˆ ---
      - name: Commit latest feed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add specs/komaru_feed.txt
          git diff --staged --quiet || git commit -m "ğŸ§  Update komaru_feed.txt [auto]"
          git push

      # --- Codexå®Ÿè¡Œæº–å‚™ ---
      - name: Prepare Codex home
        run: mkdir -p .codex_home && chmod 700 .codex_home

      # --- Codex Cloudã«ã‚ˆã‚‹è‡ªå‹•ã‚¢ãƒ—ãƒªç”Ÿæˆ ---
      - name: Generate app with Codex Cloud
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          codex-home: .codex_home        # Codexä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ˜ç¤ºæŒ‡å®š
          prompt: |
            Read the file specs/komaru_feed.txt.
            Identify the most recent â€œå›°ã‚Šã”ã¨â€ entry.
            Design and output a minimal working HTML/JS app that could help solve it.
            Include a short README.md describing purpose and usage.
            Keep it simple, creative, and ready to publish on GitHub Pages.
            Append the signature "#KGNINJA AutoApp".
          output-file: apps/latest_app/README.md
          sandbox: workspace-write

      # --- ç”Ÿæˆã‚¢ãƒ—ãƒªã‚’ã‚³ãƒŸãƒƒãƒˆ ---
      - name: Commit generated app
        run: |
          git config user.name "Codex Bot"
          git config user.email "bot@users.noreply.github.com"
          git add apps/latest_app
          git diff --staged --quiet || git commit -m "ğŸ¤– Generated AutoApp from Komaru Feed [Codex]"
          git push
